// RUN: llzk-opt -llzk-flatten -llzk-inline-structs -verify-diagnostics %s | FileCheck --enable-var-scope %s

module attributes {veridise.lang = "llzk"} {
  struct.def @NondetReg {
    struct.field @inner : !felt.type {column}
    function.def @compute(%arg0: !felt.type) -> !struct.type<@NondetReg> attributes {function.allow_witness} {
      %self = struct.new : <@NondetReg>
      struct.writef %self[@inner] = %arg0 : <@NondetReg>, !felt.type
      function.return %self : !struct.type<@NondetReg>
    }
    function.def @constrain(%arg0: !struct.type<@NondetReg>, %arg1: !felt.type) attributes {function.allow_constraint} {
      function.return
    }
  }
  struct.def @Reg {
    struct.field @"$super" : !struct.type<@NondetReg>
    struct.field @reg : !struct.type<@NondetReg> {column}
    function.def @compute(%arg0: !felt.type) -> !struct.type<@Reg> attributes {function.allow_witness} {
      %self = struct.new : <@Reg>
      %0 = function.call @NondetReg::@compute(%arg0) : (!felt.type) -> !struct.type<@NondetReg>
      struct.writef %self[@reg] = %0 : <@Reg>, !struct.type<@NondetReg>
      %1 = struct.readf %self[@reg] : <@Reg>, !struct.type<@NondetReg>
      %2 = struct.readf %1[@inner] : <@NondetReg>, !felt.type
      struct.writef %self[@"$super"] = %1 : <@Reg>, !struct.type<@NondetReg>
      function.return %self : !struct.type<@Reg>
    }
    function.def @constrain(%arg0: !struct.type<@Reg>, %arg1: !felt.type) attributes {function.allow_constraint} {
      %0 = struct.readf %arg0[@reg] : <@Reg>, !struct.type<@NondetReg>
      function.call @NondetReg::@constrain(%0, %arg1) : (!struct.type<@NondetReg>, !felt.type) -> ()
      %1 = struct.readf %0[@inner] : <@NondetReg>, !felt.type
      constrain.eq %arg1, %1 : !felt.type, !felt.type
      %2 = struct.readf %arg0[@"$super"] : <@Reg>, !struct.type<@NondetReg>
      function.call @NondetReg::@constrain(%2, %arg1) : (!struct.type<@NondetReg>, !felt.type) -> ()
      %3 = struct.readf %2[@inner] : <@NondetReg>, !felt.type
      constrain.eq %arg1, %3 : !felt.type, !felt.type
      function.return
    }
  }
}

// CHECK: TODO
