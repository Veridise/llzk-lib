// RUN: llzk-opt -I %S -split-input-file -llzk-inline-includes %s 2>&1 | FileCheck %s

module attributes {veridise.lang = "llzk"} {
  llzk.include "Inputs/header_1.llzk" as @alias1

  llzk.func @test_func() {
    llzk.call @alias1::@pkg_two::@my_func_2() : () -> ()
    return
  }
}
//CHECK-LABEL: module attributes {veridise.lang = "llzk"} {
//CHECK-NEXT:    module @alias1 attributes {veridise.lang = "llzk"} {
//CHECK-NEXT:      llzk.func private @my_func_0()
//CHECK-NEXT:      module @pkg_one {
//CHECK-NEXT:        llzk.func private @my_func_1()
//CHECK-NEXT:      }
//CHECK-NEXT:      module @pkg_two {
//CHECK-NEXT:        llzk.func private @my_func_2()
//CHECK-NEXT:      }
//CHECK-NEXT:    }
//CHECK-NEXT:    llzk.func @test_func() {
//CHECK-NEXT:      call @alias1::@pkg_two::@my_func_2() : () -> ()
//CHECK-NEXT:      return
//CHECK-NEXT:    }
//CHECK-NEXT:  }
// -----

module attributes {veridise.lang = "llzk"} {
  module @outer {
    llzk.include "Inputs/header_1.llzk" as @alias2

    llzk.func @test_func() {
      llzk.call @outer::@alias2::@pkg_two::@my_func_2() : () -> ()
      return
    }
  }
}
//CHECK-LABEL: module attributes {veridise.lang = "llzk"} {
//CHECK-NEXT:    module @outer {
//CHECK-NEXT:      module @alias2 attributes {veridise.lang = "llzk"} {
//CHECK-NEXT:        llzk.func private @my_func_0()
//CHECK-NEXT:        module @pkg_one {
//CHECK-NEXT:          llzk.func private @my_func_1()
//CHECK-NEXT:        }
//CHECK-NEXT:        module @pkg_two {
//CHECK-NEXT:          llzk.func private @my_func_2()
//CHECK-NEXT:        }
//CHECK-NEXT:      }
//CHECK-NEXT:      llzk.func @test_func() {
//CHECK-NEXT:        call @outer::@alias2::@pkg_two::@my_func_2() : () -> ()
//CHECK-NEXT:        return
//CHECK-NEXT:      }
//CHECK-NEXT:    }
//CHECK-NEXT:  }
// -----

module attributes {veridise.lang = "llzk"} {
  module @a {
    module @b {
      module @c {
        llzk.include "Inputs/header_1.llzk" as @alias3
      }
    }
  }

  llzk.func @test_func() {
    llzk.call @a::@b::@c::@alias3::@pkg_two::@my_func_2() : () -> ()
    return
  }
}
//CHECK-LABEL: module attributes {veridise.lang = "llzk"} {
//CHECK-NEXT:    module @a {
//CHECK-NEXT:      module @b {
//CHECK-NEXT:        module @c {
//CHECK-NEXT:          module @alias3 attributes {veridise.lang = "llzk"} {
//CHECK-NEXT:            llzk.func private @my_func_0()
//CHECK-NEXT:            module @pkg_one {
//CHECK-NEXT:              llzk.func private @my_func_1()
//CHECK-NEXT:            }
//CHECK-NEXT:            module @pkg_two {
//CHECK-NEXT:              llzk.func private @my_func_2()
//CHECK-NEXT:            }
//CHECK-NEXT:          }
//CHECK-NEXT:        }
//CHECK-NEXT:      }
//CHECK-NEXT:    }
//CHECK-NEXT:    llzk.func @test_func() {
//CHECK-NEXT:      call @a::@b::@c::@alias3::@pkg_two::@my_func_2() : () -> ()
//CHECK-NEXT:      return
//CHECK-NEXT:    }
//CHECK-NEXT:  }
// -----

module attributes {veridise.lang = "llzk"} {
  llzk.include "Inputs/header_2.llzk" as @double

  llzk.func @test_func() {
    llzk.call @double::@test_func() : () -> ()
    llzk.call @double::@std::@pkg_two::@my_func_2() : () -> ()
    return
  }
}
//CHECK-LABEL: module attributes {veridise.lang = "llzk"} {
//CHECK-NEXT:    module @double attributes {veridise.lang = "llzk"} {
//CHECK-NEXT:      module @std attributes {veridise.lang = "llzk"} {
//CHECK-NEXT:        llzk.func private @my_func_0()
//CHECK-NEXT:        module @pkg_one {
//CHECK-NEXT:          llzk.func private @my_func_1()
//CHECK-NEXT:        }
//CHECK-NEXT:        module @pkg_two {
//CHECK-NEXT:          llzk.func private @my_func_2()
//CHECK-NEXT:        }
//CHECK-NEXT:      }
//CHECK-NEXT:      llzk.func @test_func() {
//CHECK-NEXT:        call @std::@pkg_two::@my_func_2() : () -> ()
//CHECK-NEXT:        return
//CHECK-NEXT:      }
//CHECK-NEXT:    }
//CHECK-NEXT:    llzk.func @test_func() {
//CHECK-NEXT:      call @double::@test_func() : () -> ()
//CHECK-NEXT:      call @double::@std::@pkg_two::@my_func_2() : () -> ()
//CHECK-NEXT:      return
//CHECK-NEXT:    }
//CHECK-NEXT:  }
// -----

module attributes {veridise.lang = "llzk"} {
  llzk.include "zir_example_0.llzk" as @std

  llzk.struct @C1 {
    field @z : !llzk.struct<@std::@risc0::@Reg> {llzk.pub}

    func @compute(%x: !llzk.felt, %y: !llzk.felt) -> !llzk.struct<@C1> {
      %self = new_struct : !llzk.struct<@C1>
      %add_0 = add %x, %y
      %reg_0 = call @std::@risc0::@Reg::@compute(%add_0) : (!llzk.felt) -> (!llzk.struct<@std::@risc0::@Reg>)
      writef %self[@z] = %reg_0 : !llzk.struct<@C1>, !llzk.struct<@std::@risc0::@Reg>
      return %self: !llzk.struct<@C1>
    }

    func @constrain(%self: !llzk.struct<@C1>, %x: !llzk.felt, %y: !llzk.felt) {
      %reg_0 = readf %self[@z] : !llzk.struct<@C1>, !llzk.struct<@std::@risc0::@Reg>
      %add_0 = add %x, %y
      call @std::@risc0::@Reg::@constrain(%reg_0, %add_0) : (!llzk.struct<@std::@risc0::@Reg>, !llzk.felt) -> ()
      return
    }
  }
}
//CHECK-LABEL: module attributes {veridise.lang = "llzk"} {
//CHECK-NEXT:    module @std attributes {veridise.lang = "llzk"} {
//CHECK-NEXT:      module @risc0 {
//CHECK-NEXT:        llzk.struct @ValU32 {
//CHECK-NEXT:          field @low : !llzk.felt
//CHECK-NEXT:          field @high : !llzk.felt
//CHECK-NEXT:          func @compute(%arg0: !llzk.felt, %arg1: !llzk.felt) -> !llzk.struct<@risc0::@ValU32> {
//CHECK-NEXT:            %self = new_struct : <@risc0::@ValU32>
//CHECK-NEXT:            writef %self[@low] = %arg0 : <@risc0::@ValU32>, !llzk.felt
//CHECK-NEXT:            writef %self[@high] = %arg1 : <@risc0::@ValU32>, !llzk.felt
//CHECK-NEXT:            return %self : !llzk.struct<@risc0::@ValU32>
//CHECK-NEXT:          }
//CHECK-NEXT:          func @constrain(%arg0: !llzk.struct<@risc0::@ValU32>, %arg1: !llzk.felt, %arg2: !llzk.felt) {
//CHECK-NEXT:            return
//CHECK-NEXT:          }
//CHECK-NEXT:        }
//CHECK-NEXT:        llzk.struct @Reg {
//CHECK-NEXT:          field @reg : !llzk.felt {llzk.pub}
//CHECK-NEXT:          func @compute(%arg0: !llzk.felt) -> !llzk.struct<@risc0::@Reg> {
//CHECK-NEXT:            %self = new_struct : <@risc0::@Reg>
//CHECK-NEXT:            writef %self[@reg] = %arg0 : <@risc0::@Reg>, !llzk.felt
//CHECK-NEXT:            return %self : !llzk.struct<@risc0::@Reg>
//CHECK-NEXT:          }
//CHECK-NEXT:          func @constrain(%arg0: !llzk.struct<@risc0::@Reg>, %arg1: !llzk.felt) {
//CHECK-NEXT:            %0 = readf %arg0[@reg] : <@risc0::@Reg>, !llzk.felt
//CHECK-NEXT:            emit_eq %arg1, %0 : !llzk.felt
//CHECK-NEXT:            return
//CHECK-NEXT:          }
//CHECK-NEXT:        }
//CHECK-NEXT:        llzk.struct @Div {
//CHECK-NEXT:          field @reciprocal : !llzk.felt
//CHECK-NEXT:          field @synthetic_return : !llzk.felt {llzk.pub}
//CHECK-NEXT:          func @compute(%arg0: !llzk.felt, %arg1: !llzk.felt) -> !llzk.struct<@risc0::@Div> {
//CHECK-NEXT:            %self = new_struct : <@risc0::@Div>
//CHECK-NEXT:            %0 = inv %arg1
//CHECK-NEXT:            writef %self[@reciprocal] = %0 : <@risc0::@Div>, !llzk.felt
//CHECK-NEXT:            %1 = mul %0, %arg0
//CHECK-NEXT:            writef %self[@synthetic_return] = %1 : <@risc0::@Div>, !llzk.felt
//CHECK-NEXT:            return %self : !llzk.struct<@risc0::@Div>
//CHECK-NEXT:          }
//CHECK-NEXT:          func @constrain(%arg0: !llzk.struct<@risc0::@Div>, %arg1: !llzk.felt, %arg2: !llzk.felt) {
//CHECK-NEXT:            %0 = readf %arg0[@reciprocal] : <@risc0::@Div>, !llzk.felt
//CHECK-NEXT:            %1 = mul %0, %arg2
//CHECK-NEXT:            %felt_const_1 = constfelt  1
//CHECK-NEXT:            emit_eq %1, %felt_const_1 : !llzk.felt
//CHECK-NEXT:            %2 = readf %arg0[@synthetic_return] : <@risc0::@Div>, !llzk.felt
//CHECK-NEXT:            %3 = mul %0, %arg1
//CHECK-NEXT:            emit_eq %2, %3 : !llzk.felt
//CHECK-NEXT:            return
//CHECK-NEXT:          }
//CHECK-NEXT:        }
//CHECK-NEXT:      }
//CHECK-NEXT:    }
//CHECK-NEXT:    llzk.struct @C1 {
//CHECK-NEXT:      field @z : !llzk.struct<@std::@risc0::@Reg> {llzk.pub}
//CHECK-NEXT:      func @compute(%arg0: !llzk.felt, %arg1: !llzk.felt) -> !llzk.struct<@C1> {
//CHECK-NEXT:        %self = new_struct : <@C1>
//CHECK-NEXT:        %0 = add %arg0, %arg1
//CHECK-NEXT:        %1 = call @std::@risc0::@Reg::@compute(%0) : (!llzk.felt) -> !llzk.struct<@std::@risc0::@Reg>
//CHECK-NEXT:        writef %self[@z] = %1 : <@C1>, !llzk.struct<@std::@risc0::@Reg>
//CHECK-NEXT:        return %self : !llzk.struct<@C1>
//CHECK-NEXT:      }
//CHECK-NEXT:      func @constrain(%arg0: !llzk.struct<@C1>, %arg1: !llzk.felt, %arg2: !llzk.felt) {
//CHECK-NEXT:        %0 = readf %arg0[@z] : <@C1>, !llzk.struct<@std::@risc0::@Reg>
//CHECK-NEXT:        %1 = add %arg1, %arg2
//CHECK-NEXT:        call @std::@risc0::@Reg::@constrain(%0, %1) : (!llzk.struct<@std::@risc0::@Reg>, !llzk.felt) -> ()
//CHECK-NEXT:        return
//CHECK-NEXT:      }
//CHECK-NEXT:    }
//CHECK-NEXT:  }
// -----
