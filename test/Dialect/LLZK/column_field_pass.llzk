// RUN: llzk-opt -split-input-file %s 2>&1 | FileCheck --enable-var-scope %s

module attributes {veridise.lang = "llzk"} {
  llzk.struct @ComponentA1 {
    llzk.field @f1 : !felt.felt {column}

    function.def @constrain(%self: !llzk.struct<@ComponentA1>) { function.return }
    function.def @compute() -> !llzk.struct<@ComponentA1> {
      %self = new_struct : !llzk.struct<@ComponentA1>
      function.return %self : !llzk.struct<@ComponentA1>
    }
  }

  llzk.struct @ComponentA2 {
    function.def @compute(%p: !llzk.struct<@ComponentA1>) -> !llzk.struct<@ComponentA2> {
      %self = new_struct : !llzk.struct<@ComponentA2>
      %r = readf %p[@f1] : !llzk.struct<@ComponentA1>, !felt.felt {tableOffset = -1 : index}
      function.return %self : !llzk.struct<@ComponentA2>
    }

    function.def @constrain(%self: !llzk.struct<@ComponentA2>, %p: !llzk.struct<@ComponentA1>) {
      function.return
    }
  }
}
//CHECK-LABEL: llzk.struct @ComponentA1 {
//CHECK-NEXT:    field @f1 : !felt.felt {column}
//CHECK-NEXT:    function.def @constrain(%[[SELF:[0-9a-zA-Z_\.]+]]: !llzk.struct<@ComponentA1>) attributes {function.allow_constraint} {
//CHECK-NEXT:      function.return
//CHECK-NEXT:    }
//CHECK-NEXT:    function.def @compute() -> !llzk.struct<@ComponentA1> attributes {function.allow_witness} {
//CHECK-NEXT:      %[[SELF:[0-9a-zA-Z_\.]+]] = new_struct : <@ComponentA1>
//CHECK-NEXT:      function.return %[[SELF]] : !llzk.struct<@ComponentA1>
//CHECK-NEXT:    }
//CHECK-NEXT:  }
//CHECK-LABEL: llzk.struct @ComponentA2 {
//CHECK-NEXT:    function.def @compute(%[[A0:[0-9a-zA-Z_\.]+]]: !llzk.struct<@ComponentA1>) -> !llzk.struct<@ComponentA2> attributes {function.allow_witness} {
//CHECK-NEXT:      %[[SELF:[0-9a-zA-Z_\.]+]] = new_struct : <@ComponentA2>
//CHECK-NEXT:      %[[T0:[0-9a-zA-Z_\.]+]] = readf %[[A0]][@f1] : <@ComponentA1>, !felt.felt {tableOffset = -1 : index}
//CHECK-NEXT:      function.return %[[SELF]] : !llzk.struct<@ComponentA2>
//CHECK-NEXT:    }
//CHECK-NEXT:    function.def @constrain(%[[SELF:[0-9a-zA-Z_\.]+]]: !llzk.struct<@ComponentA2>, %[[A0:[0-9a-zA-Z_\.]+]]: !llzk.struct<@ComponentA1>) attributes {function.allow_constraint} {
//CHECK-NEXT:      function.return
//CHECK-NEXT:    }
//CHECK-NEXT:  }
// -----

module attributes {veridise.lang = "llzk"} {
  llzk.struct @ComponentA2 {
    llzk.field @f1 : !felt.felt {column}
    function.def @compute() -> !llzk.struct<@ComponentA2> {
      %self = new_struct : !llzk.struct<@ComponentA2>
      %r = readf %self[@f1] : !llzk.struct<@ComponentA2>, !felt.felt {tableOffset = -1 : index}
      function.return %self : !llzk.struct<@ComponentA2>
    }

    function.def @constrain(%self: !llzk.struct<@ComponentA2>) {
      function.return
    }
  }
}
//CHECK-LABEL: llzk.struct @ComponentA2 {
//CHECK-NEXT:    field @f1 : !felt.felt {column}
//CHECK-NEXT:    function.def @compute() -> !llzk.struct<@ComponentA2> attributes {function.allow_witness} {
//CHECK-NEXT:      %[[SELF:[0-9a-zA-Z_\.]+]] = new_struct : <@ComponentA2>
//CHECK-NEXT:      %[[T0:[0-9a-zA-Z_\.]+]] = readf %[[SELF]][@f1] : <@ComponentA2>, !felt.felt {tableOffset = -1 : index}
//CHECK-NEXT:      function.return %[[SELF]] : !llzk.struct<@ComponentA2>
//CHECK-NEXT:    }
//CHECK-NEXT:    function.def @constrain(%[[SELF:[0-9a-zA-Z_\.]+]]: !llzk.struct<@ComponentA2>) attributes {function.allow_constraint} {
//CHECK-NEXT:      function.return
//CHECK-NEXT:    }
//CHECK-NEXT:  }
// -----

module attributes {veridise.lang = "llzk"} {
  llzk.struct @ComponentA2 {
    llzk.field @f1 : !array.array<3 x !felt.felt> {column}
    function.def @compute() -> !llzk.struct<@ComponentA2> {
      %self = new_struct : !llzk.struct<@ComponentA2>
      %r = readf %self[@f1] : !llzk.struct<@ComponentA2>, !array.array<3 x !felt.felt> {tableOffset = -1 : index}
      function.return %self : !llzk.struct<@ComponentA2>
    }

    function.def @constrain(%self: !llzk.struct<@ComponentA2>) {
      function.return
    }
  }
}
//CHECK-LABEL: llzk.struct @ComponentA2 {
//CHECK-NEXT:    field @f1 : !array.array<3 x !felt.felt> {column}
//CHECK-NEXT:    function.def @compute() -> !llzk.struct<@ComponentA2> attributes {function.allow_witness} {
//CHECK-NEXT:      %[[SELF:[0-9a-zA-Z_\.]+]] = new_struct : <@ComponentA2>
//CHECK-NEXT:      %[[T0:[0-9a-zA-Z_\.]+]] = readf %[[SELF]][@f1] : <@ComponentA2>, !array.array<3 x !felt.felt> {tableOffset = -1 : index}
//CHECK-NEXT:      function.return %[[SELF]] : !llzk.struct<@ComponentA2>
//CHECK-NEXT:    }
//CHECK-NEXT:    function.def @constrain(%[[SELF:[0-9a-zA-Z_\.]+]]: !llzk.struct<@ComponentA2>) attributes {function.allow_constraint} {
//CHECK-NEXT:      function.return
//CHECK-NEXT:    }
//CHECK-NEXT:  }
// -----

module attributes {veridise.lang = "llzk"} {
  llzk.struct @ComponentA1 {
    llzk.field @f1 : !felt.felt {column}

    function.def @constrain(%self: !llzk.struct<@ComponentA1>) { function.return }
    function.def @compute() -> !llzk.struct<@ComponentA1> {
      %self = new_struct : !llzk.struct<@ComponentA1>
      function.return %self : !llzk.struct<@ComponentA1>
    }
  }
  llzk.struct @ComponentA2 {
    llzk.field @c1 : !llzk.struct<@ComponentA1> {column}
    function.def @compute() -> !llzk.struct<@ComponentA2> {
      %self = new_struct : !llzk.struct<@ComponentA2>
      %r = readf %self[@c1] : !llzk.struct<@ComponentA2>, !llzk.struct<@ComponentA1> {tableOffset = -2 : index}
      function.return %self : !llzk.struct<@ComponentA2>
    }

    function.def @constrain(%self: !llzk.struct<@ComponentA2>) {
      function.return
    }
  }
}
//CHECK-LABEL: llzk.struct @ComponentA1 {
//CHECK-NEXT:    field @f1 : !felt.felt {column}
//CHECK-NEXT:    function.def @constrain(%[[SELF:[0-9a-zA-Z_\.]+]]: !llzk.struct<@ComponentA1>) attributes {function.allow_constraint} {
//CHECK-NEXT:      function.return
//CHECK-NEXT:    }
//CHECK-NEXT:    function.def @compute() -> !llzk.struct<@ComponentA1> attributes {function.allow_witness} {
//CHECK-NEXT:      %[[SELF:[0-9a-zA-Z_\.]+]] = new_struct : <@ComponentA1>
//CHECK-NEXT:      function.return %[[SELF]] : !llzk.struct<@ComponentA1>
//CHECK-NEXT:    }
//CHECK-NEXT:  }
//CHECK-LABEL: llzk.struct @ComponentA2 {
//CHECK-NEXT:    field @c1 : !llzk.struct<@ComponentA1> {column}
//CHECK-NEXT:    function.def @compute() -> !llzk.struct<@ComponentA2> attributes {function.allow_witness} {
//CHECK-NEXT:      %[[SELF:[0-9a-zA-Z_\.]+]] = new_struct : <@ComponentA2>
//CHECK-NEXT:      %[[T0:[0-9a-zA-Z_\.]+]] = readf %[[SELF]][@c1] : <@ComponentA2>, !llzk.struct<@ComponentA1> {tableOffset = -2 : index}
//CHECK-NEXT:      function.return %[[SELF]] : !llzk.struct<@ComponentA2>
//CHECK-NEXT:    }
//CHECK-NEXT:    function.def @constrain(%[[SELF:[0-9a-zA-Z_\.]+]]: !llzk.struct<@ComponentA2>) attributes {function.allow_constraint} {
//CHECK-NEXT:      function.return
//CHECK-NEXT:    }
//CHECK-NEXT:  }
// -----
module attributes {veridise.lang = "llzk"} {
  llzk.struct @ComponentA1 {
    llzk.field @f1 : !felt.felt {column}

    function.def @constrain(%self: !llzk.struct<@ComponentA1>) { function.return }
    function.def @compute() -> !llzk.struct<@ComponentA1> {
      %self = new_struct : !llzk.struct<@ComponentA1>
      function.return %self : !llzk.struct<@ComponentA1>
    }
  }
  llzk.struct @ComponentA2 {
    llzk.field @c1 : !array.array<2 x !llzk.struct<@ComponentA1>> {column}
    function.def @compute() -> !llzk.struct<@ComponentA2> {
      %self = new_struct : !llzk.struct<@ComponentA2>
      %r = readf %self[@c1] : !llzk.struct<@ComponentA2>, !array.array<2 x !llzk.struct<@ComponentA1>> {tableOffset = -2 : index}
      function.return %self : !llzk.struct<@ComponentA2>
    }

    function.def @constrain(%self: !llzk.struct<@ComponentA2>) {
      function.return
    }
  }
}
//CHECK-LABEL: llzk.struct @ComponentA1 {
//CHECK-NEXT:    field @f1 : !felt.felt {column}
//CHECK-NEXT:    function.def @constrain(%[[SELF:[0-9a-zA-Z_\.]+]]: !llzk.struct<@ComponentA1>) attributes {function.allow_constraint} {
//CHECK-NEXT:      function.return
//CHECK-NEXT:    }
//CHECK-NEXT:    function.def @compute() -> !llzk.struct<@ComponentA1> attributes {function.allow_witness} {
//CHECK-NEXT:      %[[SELF:[0-9a-zA-Z_\.]+]] = new_struct : <@ComponentA1>
//CHECK-NEXT:      function.return %[[SELF]] : !llzk.struct<@ComponentA1>
//CHECK-NEXT:    }
//CHECK-NEXT:  }
//CHECK-LABEL: llzk.struct @ComponentA2 {
//CHECK-NEXT:    field @c1 : !array.array<2 x !llzk.struct<@ComponentA1>> {column}
//CHECK-NEXT:    function.def @compute() -> !llzk.struct<@ComponentA2> attributes {function.allow_witness} {
//CHECK-NEXT:      %[[SELF:[0-9a-zA-Z_\.]+]] = new_struct : <@ComponentA2>
//CHECK-NEXT:      %[[T0:[0-9a-zA-Z_\.]+]] = readf %[[SELF]][@c1] : <@ComponentA2>, !array.array<2 x !llzk.struct<@ComponentA1>> {tableOffset = -2 : index}
//CHECK-NEXT:      function.return %[[SELF]] : !llzk.struct<@ComponentA2>
//CHECK-NEXT:    }
//CHECK-NEXT:    function.def @constrain(%[[SELF:[0-9a-zA-Z_\.]+]]: !llzk.struct<@ComponentA2>) attributes {function.allow_constraint} {
//CHECK-NEXT:      function.return
//CHECK-NEXT:    }
//CHECK-NEXT:  }
// -----

module attributes {veridise.lang = "llzk"} {
  llzk.struct @ComponentA1<[@T]> {
    llzk.field @f1 : !llzk.tvar<@T> {column}

    function.def @constrain(%self: !llzk.struct<@ComponentA1<[@T]>>) { function.return }
    function.def @compute() -> !llzk.struct<@ComponentA1<[@T]>> {
      %self = new_struct : !llzk.struct<@ComponentA1<[@T]>>
      function.return %self : !llzk.struct<@ComponentA1<[@T]>>
    }
  }
}
//CHECK-LABEL: llzk.struct @ComponentA1<[@T]> {
//CHECK-NEXT:    field @f1 : !llzk.tvar<@T> {column}
//CHECK-NEXT:    function.def @constrain(%[[SELF:[0-9a-zA-Z_\.]+]]: !llzk.struct<@ComponentA1<[@T]>>) attributes {function.allow_constraint} {
//CHECK-NEXT:      function.return
//CHECK-NEXT:    }
//CHECK-NEXT:    function.def @compute() -> !llzk.struct<@ComponentA1<[@T]>> attributes {function.allow_witness} {
//CHECK-NEXT:      %[[SELF:[0-9a-zA-Z_\.]+]] = new_struct : <@ComponentA1<[@T]>>
//CHECK-NEXT:      function.return %[[SELF]] : !llzk.struct<@ComponentA1<[@T]>>
//CHECK-NEXT:    }
//CHECK-NEXT:  }

