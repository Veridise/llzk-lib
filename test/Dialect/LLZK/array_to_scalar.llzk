// RUN: llzk-opt -I %S -split-input-file -llzk-array-to-scalar %s | FileCheck --enable-var-scope %s

module attributes {veridise.lang = "llzk"} {
  llzk.func @new_then_read() -> index {
    %0 = arith.constant 0 : index
    %1 = arith.constant 1 : index

    %a = arith.constant 45 : index
    %b = arith.constant 214 : index
    %c = arith.constant 15875 : index
    %d = arith.constant 769 : index

    %r = llzk.new_array %a, %b, %c, %d, %c, %a: !llzk.array<2,3 x index>
    %x = llzk.readarr %r[%1,%0] : !llzk.array<2,3 x index>, index
    return %x : index
  }
}
// CHECK-LABEL: llzk.func @new_then_read() -> index {
// CHECK-NEXT:    %[[V:[0-9a-zA-Z_\.]+]] = arith.constant 769 : index
// CHECK-NEXT:    return %[[V]] : index
// CHECK-NEXT:  }
// -----

module attributes {veridise.lang = "llzk"} {
  llzk.func @multiple_read_and_write() -> !llzk.felt {
    %0 = arith.constant 0 : index
    %1 = arith.constant 1 : index
    %2 = arith.constant 2 : index

    %a = llzk.constfelt 2
    %b = llzk.constfelt 3
    %c = llzk.constfelt 5
    %d = llzk.constfelt 7
    %e = llzk.constfelt 11
    %f = llzk.constfelt 13
    %g = llzk.constfelt 17
    %h = llzk.constfelt 19
    %i = llzk.constfelt 23
    %j = llzk.constfelt 29

    %r = llzk.new_array %a, %b, %c, %d, %e, %f, %g, %h: !llzk.array<4,2 x !llzk.felt>
    %x = llzk.readarr %r[%2,%0] : !llzk.array<4,2 x !llzk.felt>, !llzk.felt
    // overwrite the same index to ensure the read survives
    llzk.writearr %r[%1,%0] = %i : !llzk.array<4,2 x !llzk.felt>, !llzk.felt
    // write to a different index and then read it to ensure the new value is used
    llzk.writearr %r[%0,%1] = %j : !llzk.array<4,2 x !llzk.felt>, !llzk.felt
    %y = llzk.readarr %r[%0,%1] : !llzk.array<4,2 x !llzk.felt>, !llzk.felt
    // e * j
    %z = mul %x, %y
    return %z : !llzk.felt
  }
}
// CHECK-LABEL: llzk.func @multiple_read_and_write() -> !llzk.felt {
// CHECK-NEXT:    %[[V0:[0-9a-zA-Z_\.]+]] = constfelt  11
// CHECK-NEXT:    %[[V1:[0-9a-zA-Z_\.]+]] = constfelt  29
// CHECK-NEXT:    %[[V2:[0-9a-zA-Z_\.]+]] = mul %[[V0]], %[[V1]] : !llzk.felt, !llzk.felt
// CHECK-NEXT:    return %[[V2]] : !llzk.felt
// CHECK-NEXT:  }
// -----

module attributes {veridise.lang = "llzk"} {
  llzk.func @new_then_return() -> !llzk.array<2,1,2 x !llzk.felt> {
    %a = llzk.constfelt 45
    %b = llzk.constfelt 214
    %c = llzk.constfelt 2
    %d = llzk.constfelt 52
  
    %r = llzk.new_array %a, %b, %c, %d : !llzk.array<2,1,2 x !llzk.felt>
    return %r: !llzk.array<2,1,2 x !llzk.felt>
  }
}
// CHECK-LABEL: llzk.func @new_then_return() -> (!llzk.felt, !llzk.felt, !llzk.felt, !llzk.felt) {
// CHECK-NEXT:    %[[V0:[0-9a-zA-Z_\.]+]] = constfelt  45
// CHECK-NEXT:    %[[V1:[0-9a-zA-Z_\.]+]] = constfelt  214
// CHECK-NEXT:    %[[V2:[0-9a-zA-Z_\.]+]] = constfelt  2
// CHECK-NEXT:    %[[V3:[0-9a-zA-Z_\.]+]] = constfelt  52
// CHECK-NEXT:    return %[[V0]], %[[V1]], %[[V2]], %[[V3]] : !llzk.felt, !llzk.felt, !llzk.felt, !llzk.felt
// CHECK-NEXT:  }
// -----

module attributes {veridise.lang = "llzk"} {
  llzk.func @len() -> index {
    %a = llzk.new_array  : !llzk.array<6,1,2,1,5,1 x !llzk.felt>
    %4 = arith.constant 4 : index
    %z = llzk.array_len %a, %4 : !llzk.array<6,1,2,1,5,1 x !llzk.felt> // result is 5
    return %z: index
  }
}
// CHECK-LABEL: llzk.func @len() -> index {
// CHECK-NEXT:    %[[V0:[0-9a-zA-Z_\.]+]] = arith.constant 5 : index
// CHECK-NEXT:    return %[[V0]] : index
// CHECK-NEXT:  }
// -----

module attributes {veridise.lang = "llzk"} {
  llzk.func @convert_arg(%a: !llzk.array<3,1,2,1,4,1 x !llzk.felt>) -> !llzk.felt {
    %0 = arith.constant 0 : index
    %1 = arith.constant 1 : index
    %z = llzk.readarr %a[%1,%0,%1,%0,%1,%0] : !llzk.array<3,1,2,1,4,1 x !llzk.felt>, !llzk.felt
    return %z: !llzk.felt
  }
}
// CHECK-LABEL: llzk.func @convert_arg(
// CHECK-SAME:              %[[V0:[0-9a-zA-Z_\.]+]]: !llzk.felt,
// CHECK-SAME:              %[[V1:[0-9a-zA-Z_\.]+]]: !llzk.felt,
// CHECK-SAME:              %[[V2:[0-9a-zA-Z_\.]+]]: !llzk.felt,
// CHECK-SAME:              %[[V3:[0-9a-zA-Z_\.]+]]: !llzk.felt,
// CHECK-SAME:              %[[V4:[0-9a-zA-Z_\.]+]]: !llzk.felt,
// CHECK-SAME:              %[[V5:[0-9a-zA-Z_\.]+]]: !llzk.felt,
// CHECK-SAME:              %[[V6:[0-9a-zA-Z_\.]+]]: !llzk.felt,
// CHECK-SAME:              %[[V7:[0-9a-zA-Z_\.]+]]: !llzk.felt,
// CHECK-SAME:              %[[V8:[0-9a-zA-Z_\.]+]]: !llzk.felt,
// CHECK-SAME:              %[[V9:[0-9a-zA-Z_\.]+]]: !llzk.felt,
// CHECK-SAME:              %[[V10:[0-9a-zA-Z_\.]+]]: !llzk.felt,
// CHECK-SAME:              %[[V11:[0-9a-zA-Z_\.]+]]: !llzk.felt,
// CHECK-SAME:              %[[V12:[0-9a-zA-Z_\.]+]]: !llzk.felt,
// CHECK-SAME:              %[[V13:[0-9a-zA-Z_\.]+]]: !llzk.felt,
// CHECK-SAME:              %[[V14:[0-9a-zA-Z_\.]+]]: !llzk.felt,
// CHECK-SAME:              %[[V15:[0-9a-zA-Z_\.]+]]: !llzk.felt,
// CHECK-SAME:              %[[V16:[0-9a-zA-Z_\.]+]]: !llzk.felt,
// CHECK-SAME:              %[[V17:[0-9a-zA-Z_\.]+]]: !llzk.felt,
// CHECK-SAME:              %[[V18:[0-9a-zA-Z_\.]+]]: !llzk.felt,
// CHECK-SAME:              %[[V19:[0-9a-zA-Z_\.]+]]: !llzk.felt,
// CHECK-SAME:              %[[V20:[0-9a-zA-Z_\.]+]]: !llzk.felt,
// CHECK-SAME:              %[[V21:[0-9a-zA-Z_\.]+]]: !llzk.felt,
// CHECK-SAME:              %[[V22:[0-9a-zA-Z_\.]+]]: !llzk.felt,
// CHECK-SAME:              %[[V23:[0-9a-zA-Z_\.]+]]: !llzk.felt) -> !llzk.felt {
// CHECK-NEXT:    return %[[V13]] : !llzk.felt
// CHECK-NEXT:  }
// -----

module attributes {veridise.lang = "llzk"} {
  llzk.func @uninitialized() -> index {
    %0 = arith.constant 0 : index
    %1 = arith.constant 1 : index

    %r = llzk.new_array : !llzk.array<2,3 x index>
    %x = llzk.readarr %r[%1,%0] : !llzk.array<2,3 x index>, index
    return %x : index
  }
}
// CHECK-LABEL: llzk.func @uninitialized() -> index {
// CHECK-NEXT:    %[[V0:[0-9a-zA-Z_\.]+]] = undef : index
// CHECK-NEXT:    return %[[V0]] : index
// CHECK-NEXT:  }
// -----

module attributes {veridise.lang = "llzk"} {
  llzk.func @f1(%arg: !llzk.felt) -> !llzk.array<3,2 x !llzk.felt> {
    %0 = arith.constant 0 : index
    %a = llzk.call @f2() : () -> !llzk.array<3,2 x !llzk.felt>
    llzk.writearr %a[%0,%0] = %arg : !llzk.array<3,2 x !llzk.felt>, !llzk.felt
    return %a : !llzk.array<3,2 x !llzk.felt>
  }

  llzk.func @f2() -> !llzk.array<3,2 x !llzk.felt> {
    %a = llzk.new_array : !llzk.array<3,2 x !llzk.felt>
    return %a : !llzk.array<3,2 x !llzk.felt>
  }
}
// CHECK-LABEL: llzk.func @f1(
// CHECK-SAME:           %[[V0:[0-9a-zA-Z_\.]+]]: !llzk.felt) -> (!llzk.felt, !llzk.felt, !llzk.felt, !llzk.felt, !llzk.felt, !llzk.felt) {
// CHECK-NEXT:    %[[V1:[0-9a-zA-Z_\.]+]]:6 = call @f2() : () -> (!llzk.felt, !llzk.felt, !llzk.felt, !llzk.felt, !llzk.felt, !llzk.felt)
// CHECK-NEXT:    return %[[V0]], %[[V1]]#1, %[[V1]]#2, %[[V1]]#3, %[[V1]]#4, %[[V1]]#5 : !llzk.felt, !llzk.felt, !llzk.felt, !llzk.felt, !llzk.felt, !llzk.felt
// CHECK-NEXT:  }
//
// CHECK-LABEL: llzk.func @f2() -> (!llzk.felt, !llzk.felt, !llzk.felt, !llzk.felt, !llzk.felt, !llzk.felt) {
// CHECK-NEXT:    %[[V0:[0-9a-zA-Z_\.]+]] = undef : !llzk.felt
// CHECK-NEXT:    %[[V1:[0-9a-zA-Z_\.]+]] = undef : !llzk.felt
// CHECK-NEXT:    %[[V2:[0-9a-zA-Z_\.]+]] = undef : !llzk.felt
// CHECK-NEXT:    %[[V3:[0-9a-zA-Z_\.]+]] = undef : !llzk.felt
// CHECK-NEXT:    %[[V4:[0-9a-zA-Z_\.]+]] = undef : !llzk.felt
// CHECK-NEXT:    %[[V5:[0-9a-zA-Z_\.]+]] = undef : !llzk.felt
// CHECK-NEXT:    return %[[V5]], %[[V4]], %[[V3]], %[[V2]], %[[V1]], %[[V0]] : !llzk.felt, !llzk.felt, !llzk.felt, !llzk.felt, !llzk.felt, !llzk.felt
// CHECK-NEXT:  }
// -----

module attributes {veridise.lang = "llzk"} {
  llzk.func @new_then_write_then_read() -> !llzk.felt {
    %0 = arith.constant 0 : index
    %1 = arith.constant 1 : index

    %a = llzk.constfelt 0
    %b = llzk.constfelt 424867
    %c = llzk.constfelt 2465
    %d = llzk.constfelt 367

    %r = llzk.new_array %a, %a, %a, %a: !llzk.array<2,2 x !llzk.felt>
    llzk.writearr %r[%0,%1] = %b: !llzk.array<2,2 x !llzk.felt>, !llzk.felt
    llzk.writearr %r[%0,%0] = %c: !llzk.array<2,2 x !llzk.felt>, !llzk.felt
    llzk.writearr %r[%1,%0] = %d: !llzk.array<2,2 x !llzk.felt>, !llzk.felt
    // [[2465, 424867],[367, 0]]
    %w = llzk.readarr %r[%0,%0] : !llzk.array<2,2 x !llzk.felt>, !llzk.felt
    %x = llzk.readarr %r[%0,%1] : !llzk.array<2,2 x !llzk.felt>, !llzk.felt
    %y = llzk.readarr %r[%1,%0] : !llzk.array<2,2 x !llzk.felt>, !llzk.felt
    %z = llzk.readarr %r[%1,%1] : !llzk.array<2,2 x !llzk.felt>, !llzk.felt

    %s1 = llzk.add %w, %x   // 2465 + 424867
    %s2 = llzk.add %s1, %y  // ^ + 367
    %s3 = llzk.add %s2, %z  // ^ + 0
    return %s3 : !llzk.felt
  }
}
// CHECK-LABEL: llzk.func @new_then_write_then_read() -> !llzk.felt {
// CHECK-NEXT:    %[[V0:[0-9a-zA-Z_\.]+]] = constfelt  0
// CHECK-NEXT:    %[[V1:[0-9a-zA-Z_\.]+]] = constfelt  424867
// CHECK-NEXT:    %[[V2:[0-9a-zA-Z_\.]+]] = constfelt  2465
// CHECK-NEXT:    %[[V3:[0-9a-zA-Z_\.]+]] = constfelt  367
// CHECK-NEXT:    %[[V4:[0-9a-zA-Z_\.]+]] = add %[[V1]], %[[V2]] : !llzk.felt, !llzk.felt
// CHECK-NEXT:    %[[V5:[0-9a-zA-Z_\.]+]] = add %[[V4]], %[[V3]] : !llzk.felt, !llzk.felt
// CHECK-NEXT:    %[[V6:[0-9a-zA-Z_\.]+]] = add %[[V5]], %[[V0]] : !llzk.felt, !llzk.felt
// CHECK-NEXT:    return %[[V6]] : !llzk.felt
// CHECK-NEXT:  }
