// RUN: llzk-opt %s 2>&1 | FileCheck %s
// RUN: llzk-opt -llzk-print-call-graph %s 2>&1 | FileCheck %s --check-prefix CG
// RUN: llzk-opt -llzk-print-call-graph-sccs %s 2>&1 | FileCheck %s --check-prefix SCC

module attributes {veridise.lang = "llzk"} {

  /////////////////////////////////////////////////////////////////////////////////////////////
  // BEGIN: This section should be removed once implemented properly. It is tested elsewhere.
  // Pre-defined structs to import in all files generated by zirgen frontend
  module @risc0 {
    llzk.struct @ValU32 {
      field @low : !llzk.felt
      field @high : !llzk.felt
      func @compute(%low: !llzk.felt, %high: !llzk.felt) -> !llzk.struct<@risc0::@ValU32> {
        %self = new_struct : !llzk.struct<@risc0::@ValU32>
        writef %self[@low] = %low : !llzk.struct<@risc0::@ValU32>, !llzk.felt
        writef %self[@high] = %high : !llzk.struct<@risc0::@ValU32>, !llzk.felt
        return %self : !llzk.struct<@risc0::@ValU32>
      }
      func @constrain(%self: !llzk.struct<@risc0::@ValU32>, %low: !llzk.felt, %high: !llzk.felt) {
        return
      }
    }
    llzk.struct @Reg {
      field @reg : !llzk.felt {llzk.pub}
      func @compute(%v: !llzk.felt) -> !llzk.struct<@risc0::@Reg> {
        %self = new_struct : !llzk.struct<@risc0::@Reg>
        writef %self[@reg] = %v : !llzk.struct<@risc0::@Reg>, !llzk.felt
        return %self : !llzk.struct<@risc0::@Reg>
      }
      func @constrain(%self: !llzk.struct<@risc0::@Reg>, %v: !llzk.felt) {
        %0 = readf %self[@reg] : !llzk.struct<@risc0::@Reg>, !llzk.felt
        emit_eq %v, %0 : !llzk.felt
        return
      }
    }
  }
  // END: This section should be removed once implemented properly. It is tested elsewhere.
  /////////////////////////////////////////////////////////////////////////////////////////////

  llzk.struct @C1 {
    field @z : !llzk.struct<@risc0::@Reg> {llzk.pub}

    func @compute(%x: !llzk.felt, %y: !llzk.felt) -> !llzk.struct<@C1> {
      %self = new_struct : !llzk.struct<@C1>
      %add_0 = add %x, %y
      %reg_0 = call @risc0::@Reg::@compute(%add_0) : (!llzk.felt) -> (!llzk.struct<@risc0::@Reg>)
      writef %self[@z] = %reg_0 : !llzk.struct<@C1>, !llzk.struct<@risc0::@Reg>
      return %self: !llzk.struct<@C1>
    }

    func @constrain(%self: !llzk.struct<@C1>, %x: !llzk.felt, %y: !llzk.felt) {
      %reg_0 = readf %self[@z] : !llzk.struct<@C1>, !llzk.struct<@risc0::@Reg>
      %add_0 = add %x, %y
      call @risc0::@Reg::@constrain(%reg_0, %add_0) : (!llzk.struct<@risc0::@Reg>, !llzk.felt) -> ()
      return
    }
  }

  llzk.struct @C2 {
    field @fc1 : !llzk.struct<@C1>

    func @compute(%x: !llzk.struct<@risc0::@ValU32>) -> !llzk.struct<@C2> {
      %self = new_struct : !llzk.struct<@C2>
      %t1 = readf %x[@low] : !llzk.struct<@risc0::@ValU32>, !llzk.felt
      %t2 = readf %x[@high] : !llzk.struct<@risc0::@ValU32>, !llzk.felt
      %t0 = call @C1::@compute(%t1, %t2) : (!llzk.felt, !llzk.felt) -> (!llzk.struct<@C1>)
      writef %self[@fc1] = %t0 : !llzk.struct<@C2>, !llzk.struct<@C1>
      //
      return %self: !llzk.struct<@C2>
    }

    func @constrain(%self: !llzk.struct<@C2>, %x: !llzk.struct<@risc0::@ValU32>) {
      // c1.constrain(x.low, x.high)
      %t0 = readf %self[@fc1] : !llzk.struct<@C2>, !llzk.struct<@C1>
      %t1 = readf %x[@low] : !llzk.struct<@risc0::@ValU32>, !llzk.felt
      %t2 = readf %x[@high] : !llzk.struct<@risc0::@ValU32>, !llzk.felt
      call @C1::@constrain(%t0, %t1, %t2) : (!llzk.struct<@C1>, !llzk.felt, !llzk.felt) -> ()
      // emit c1.z.reg = 0
      %t3 = readf %t0[@z] : !llzk.struct<@C1>, !llzk.struct<@risc0::@Reg>
      %t4 = readf %t3[@reg] : !llzk.struct<@risc0::@Reg>, !llzk.felt
      %zero = constfelt 0
      emit_eq %t4, %zero : !llzk.felt
      //
      return
    }
  }
}

//CHECK-LABEL: module attributes {veridise.lang = "llzk"} {
//CHECK-NEXT:    module @risc0 {
//CHECK-NEXT:      llzk.struct @ValU32 {
//CHECK-NEXT:        field @low : !llzk.felt
//CHECK-NEXT:        field @high : !llzk.felt
//CHECK-NEXT:        func @compute(%[[A0:[0-9a-zA-Z_\.]+]]: !llzk.felt, %[[A1:[0-9a-zA-Z_\.]+]]: !llzk.felt) -> !llzk.struct<@risc0::@ValU32> {
//CHECK-NEXT:          %[[SELF:[0-9a-zA-Z_\.]+]] = new_struct : <@risc0::@ValU32>
//CHECK-NEXT:          writef %[[SELF]][@low] = %[[A0]] : <@risc0::@ValU32>, !llzk.felt
//CHECK-NEXT:          writef %[[SELF]][@high] = %[[A1]] : <@risc0::@ValU32>, !llzk.felt
//CHECK-NEXT:          return %[[SELF]] : !llzk.struct<@risc0::@ValU32>
//CHECK-NEXT:        }
//CHECK-NEXT:        func @constrain(%[[SELF:[0-9a-zA-Z_\.]+]]: !llzk.struct<@risc0::@ValU32>,
//CHECK-SAME:        %[[A1:[0-9a-zA-Z_\.]+]]: !llzk.felt, %[[A2:[0-9a-zA-Z_\.]+]]: !llzk.felt) {
//CHECK-NEXT:          return
//CHECK-NEXT:        }
//CHECK-NEXT:      }
//CHECK-NEXT:      llzk.struct @Reg {
//CHECK-NEXT:        field @reg : !llzk.felt {llzk.pub}
//CHECK-NEXT:        func @compute(%[[A0:[0-9a-zA-Z_\.]+]]: !llzk.felt) -> !llzk.struct<@risc0::@Reg> {
//CHECK-NEXT:          %[[SELF:[0-9a-zA-Z_\.]+]] = new_struct : <@risc0::@Reg>
//CHECK-NEXT:          writef %[[SELF]][@reg] = %[[A0]] : <@risc0::@Reg>, !llzk.felt
//CHECK-NEXT:          return %[[SELF]] : !llzk.struct<@risc0::@Reg>
//CHECK-NEXT:        }
//CHECK-NEXT:        func @constrain(%[[SELF:[0-9a-zA-Z_\.]+]]: !llzk.struct<@risc0::@Reg>, %[[A1:[0-9a-zA-Z_\.]+]]: !llzk.felt) {
//CHECK-NEXT:          %[[T0:[0-9a-zA-Z_\.]+]] = readf %[[SELF]][@reg] : <@risc0::@Reg>, !llzk.felt
//CHECK-NEXT:          emit_eq %[[A1]], %[[T0]] : !llzk.felt, !llzk.felt
//CHECK-NEXT:          return
//CHECK-NEXT:        }
//CHECK-NEXT:      }
//CHECK-NEXT:    }
//CHECK-NEXT:    llzk.struct @C1 {
//CHECK-NEXT:      field @z : !llzk.struct<@risc0::@Reg> {llzk.pub}
//CHECK-NEXT:      func @compute(%arg0: !llzk.felt, %arg1: !llzk.felt) -> !llzk.struct<@C1> {
//CHECK-NEXT:        %[[SELF:[0-9a-zA-Z_\.]+]] = new_struct : <@C1>
//CHECK-NEXT:        %[[T0:[0-9a-zA-Z_\.]+]] = add %arg0, %arg1
//CHECK-NEXT:        %[[T1:[0-9a-zA-Z_\.]+]] = call @risc0::@Reg::@compute(%[[T0]]) : (!llzk.felt) -> !llzk.struct<@risc0::@Reg>
//CHECK-NEXT:        writef %[[SELF]][@z] = %[[T1]] : <@C1>, !llzk.struct<@risc0::@Reg>
//CHECK-NEXT:        return %[[SELF]] : !llzk.struct<@C1>
//CHECK-NEXT:      }
//CHECK-NEXT:      func @constrain(%[[SELF:[0-9a-zA-Z_\.]+]]: !llzk.struct<@C1>, %arg1: !llzk.felt, %arg2: !llzk.felt) {
//CHECK-NEXT:        %[[T0:[0-9a-zA-Z_\.]+]] = readf %[[SELF]][@z] : <@C1>, !llzk.struct<@risc0::@Reg>
//CHECK-NEXT:        %[[T1:[0-9a-zA-Z_\.]+]] = add %arg1, %arg2
//CHECK-NEXT:        call @risc0::@Reg::@constrain(%[[T0]], %[[T1]]) : (!llzk.struct<@risc0::@Reg>, !llzk.felt) -> ()
//CHECK-NEXT:        return
//CHECK-NEXT:      }
//CHECK-NEXT:    }
//CHECK-NEXT:    llzk.struct @C2 {
//CHECK-NEXT:      field @fc1 : !llzk.struct<@C1>
//CHECK-NEXT:      func @compute(%arg0: !llzk.struct<@risc0::@ValU32>) -> !llzk.struct<@C2> {
//CHECK-NEXT:        %[[SELF:[0-9a-zA-Z_\.]+]] = new_struct : <@C2>
//CHECK-NEXT:        %[[T0:[0-9a-zA-Z_\.]+]] = readf %arg0[@low] : <@risc0::@ValU32>, !llzk.felt
//CHECK-NEXT:        %[[T1:[0-9a-zA-Z_\.]+]] = readf %arg0[@high] : <@risc0::@ValU32>, !llzk.felt
//CHECK-NEXT:        %[[T2:[0-9a-zA-Z_\.]+]] = call @C1::@compute(%[[T0]], %[[T1]]) : (!llzk.felt, !llzk.felt) -> !llzk.struct<@C1>
//CHECK-NEXT:        writef %[[SELF]][@fc1] = %[[T2]] : <@C2>, !llzk.struct<@C1>
//CHECK-NEXT:        return %[[SELF]] : !llzk.struct<@C2>
//CHECK-NEXT:      }
//CHECK-NEXT:      func @constrain(%[[SELF:[0-9a-zA-Z_\.]+]]: !llzk.struct<@C2>, %arg1: !llzk.struct<@risc0::@ValU32>) {
//CHECK-NEXT:        %[[T0:[0-9a-zA-Z_\.]+]] = readf %[[SELF]][@fc1] : <@C2>, !llzk.struct<@C1>
//CHECK-NEXT:        %[[T1:[0-9a-zA-Z_\.]+]] = readf %arg1[@low] : <@risc0::@ValU32>, !llzk.felt
//CHECK-NEXT:        %[[T2:[0-9a-zA-Z_\.]+]] = readf %arg1[@high] : <@risc0::@ValU32>, !llzk.felt
//CHECK-NEXT:        call @C1::@constrain(%[[T0]], %[[T1]], %[[T2]]) : (!llzk.struct<@C1>, !llzk.felt, !llzk.felt) -> ()
//CHECK-NEXT:        %[[T3:[0-9a-zA-Z_\.]+]] = readf %[[T0]][@z] : <@C1>, !llzk.struct<@risc0::@Reg>
//CHECK-NEXT:        %[[T4:[0-9a-zA-Z_\.]+]] = readf %[[T3]][@reg] : <@risc0::@Reg>, !llzk.felt
//CHECK-NEXT:        %felt_const_0 = constfelt  0
//CHECK-NEXT:        emit_eq %[[T4]], %felt_const_0 : !llzk.felt, !llzk.felt
//CHECK-NEXT:        return
//CHECK-NEXT:      }
//CHECK-NEXT:    }
//CHECK-NEXT:  }

// CG: // ---- CallGraph ----
// CG-DAG: // - Node : 'llzk.func' - Region #0 : {function_type = (!llzk.felt, !llzk.felt) -> !llzk.struct<@risc0::@ValU32>, sym_name = "compute"}
// CG-NEXT: //
// CG-DAG: // - Node : 'llzk.func' - Region #0 : {function_type = (!llzk.struct<@risc0::@ValU32>, !llzk.felt, !llzk.felt) -> (), sym_name = "constrain"}
// CG-NEXT: //
// CG-DAG: // - Node : 'llzk.func' - Region #0 : {function_type = (!llzk.felt) -> !llzk.struct<@risc0::@Reg>, sym_name = "compute"}
// CG-NEXT: //
// CG-DAG: // - Node : 'llzk.func' - Region #0 : {function_type = (!llzk.struct<@risc0::@Reg>, !llzk.felt) -> (), sym_name = "constrain"}
// CG-NEXT: //
// CG-DAG: // - Node : 'llzk.func' - Region #0 : {function_type = (!llzk.felt, !llzk.felt) -> !llzk.struct<@C1>, sym_name = "compute"}
// CG-NEXT: // -- Call-Edge : 'llzk.func' - Region #0 : {function_type = (!llzk.felt) -> !llzk.struct<@risc0::@Reg>, sym_name = "compute"}
// CG-NEXT: //
// CG-DAG: // - Node : 'llzk.func' - Region #0 : {function_type = (!llzk.struct<@C1>, !llzk.felt, !llzk.felt) -> (), sym_name = "constrain"}
// CG-NEXT: // -- Call-Edge : 'llzk.func' - Region #0 : {function_type = (!llzk.struct<@risc0::@Reg>, !llzk.felt) -> (), sym_name = "constrain"}
// CG-NEXT: //
// CG-DAG: // - Node : 'llzk.func' - Region #0 : {function_type = (!llzk.struct<@risc0::@ValU32>) -> !llzk.struct<@C2>, sym_name = "compute"}
// CG-NEXT: // -- Call-Edge : 'llzk.func' - Region #0 : {function_type = (!llzk.felt, !llzk.felt) -> !llzk.struct<@C1>, sym_name = "compute"}
// CG-NEXT: //
// CG-DAG: // - Node : 'llzk.func' - Region #0 : {function_type = (!llzk.struct<@C2>, !llzk.struct<@risc0::@ValU32>) -> (), sym_name = "constrain"}
// CG-NEXT: // -- Call-Edge : 'llzk.func' - Region #0 : {function_type = (!llzk.struct<@C1>, !llzk.felt, !llzk.felt) -> (), sym_name = "constrain"}
// CG-NEXT: //
// CG-NEXT: // -- SCCs --
// CG-DAG: // - SCC :
// CG-NEXT: // -- Node :'llzk.func' - Region #0 : {function_type = (!llzk.felt, !llzk.felt) -> !llzk.struct<@risc0::@ValU32>, sym_name = "compute"}
// CG-EMPTY:
// CG-DAG: // - SCC :
// CG-NEXT: // -- Node :'llzk.func' - Region #0 : {function_type = (!llzk.struct<@risc0::@ValU32>, !llzk.felt, !llzk.felt) -> (), sym_name = "constrain"}
// CG-EMPTY:
// CG-DAG: // - SCC :
// CG-NEXT: // -- Node :'llzk.func' - Region #0 : {function_type = (!llzk.felt) -> !llzk.struct<@risc0::@Reg>, sym_name = "compute"}
// CG-EMPTY:
// CG-DAG: // - SCC :
// CG-NEXT: // -- Node :'llzk.func' - Region #0 : {function_type = (!llzk.struct<@risc0::@Reg>, !llzk.felt) -> (), sym_name = "constrain"}
// CG-EMPTY:
// CG-DAG: // - SCC :
// CG-NEXT: // -- Node :'llzk.func' - Region #0 : {function_type = (!llzk.felt, !llzk.felt) -> !llzk.struct<@C1>, sym_name = "compute"}
// CG-NEMPTY
// CG-DAG: // - SCC :
// CG-NEXT: // -- Node :'llzk.func' - Region #0 : {function_type = (!llzk.struct<@C1>, !llzk.felt, !llzk.felt) -> (), sym_name = "constrain"}
// CG-EMPTY:
// CG-DAG: // - SCC :
// CG-NEXT: // -- Node :'llzk.func' - Region #0 : {function_type = (!llzk.struct<@risc0::@ValU32>) -> !llzk.struct<@C2>, sym_name = "compute"}
// CG-EMPTY:
// CG-DAG: // - SCC :
// CG-NEXT: // -- Node :'llzk.func' - Region #0 : {function_type = (!llzk.struct<@C2>, !llzk.struct<@risc0::@ValU32>) -> (), sym_name = "constrain"}
// CG-EMPTY:
// CG-DAG: // - SCC :
// CG-NEXT: // -- Node :<External-Caller-Node>

// SCC: SCCs for the program in PostOrder:
// SCC-NEXT: SCC #1: @risc0::@ValU32::@compute
// SCC-NEXT: SCC #2: @risc0::@ValU32::@constrain
// SCC-NEXT: SCC #3: @risc0::@Reg::@compute
// SCC-NEXT: SCC #4: @risc0::@Reg::@constrain
// SCC-NEXT: SCC #5: @C1::@compute
// SCC-NEXT: SCC #6: @C1::@constrain
// SCC-NEXT: SCC #7: @C2::@compute
// SCC-NEXT: SCC #8: @C2::@constrain
// SCC-NEXT: SCC #9: external node